name: Discord Push Notification

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Send Discord notification
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          MODS_CATEGORY_ID: ${{ secrets.MODS_CATEGORY_ID }}
        run: |
          set -eo pipefail

          # === Gather commit info ===
          TITLE=$(git log -1 --pretty=%s)
          AUTHOR=$(git log -1 --pretty=%an)
          SHA=$(git log -1 --pretty=%h)
          FULL_SHA="${{ github.sha }}"
          BEFORE="${{ github.event.before }}"
          BRANCH="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # === Determine commit type and color (case-insensitive) ===
          TYPE="üìù Update"
          COLOR=9807270

          shopt -s nocasematch
          case "$TITLE" in
            fix*|bug*|patch*)          TYPE="üêõ Bug Fix";       COLOR=15158332 ;;
            feat*|add*|new*)           TYPE="‚ú® New Feature";   COLOR=3066993  ;;
            refactor*|clean*|improve*) TYPE="‚ôªÔ∏è Refactor";      COLOR=10181046 ;;
            doc*|readme*)              TYPE="üìö Documentation"; COLOR=3447003  ;;
            test*)                     TYPE="üß™ Tests";         COLOR=16776960 ;;
          esac
          shopt -u nocasematch

          # === Extract body (bullet points to numbered list) ===
          RAW_BODY=$(git log -1 --pretty=%b)
          BODY=""
          if [ -n "$RAW_BODY" ]; then
            BODY=$(echo "$RAW_BODY" | grep -E '^\s*-\s+' | sed 's/^\s*-\s*//' | nl -w1 -s'. ' | sed 's/^ *//' || true)
          fi

          # === Get file changes (handle first commit) ===
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            FILE_COUNT=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | wc -l | tr -d ' ')
            FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | head -8 | tr '\n' ',' | sed 's/,$//')

            STAT_LINE=$(git diff --shortstat HEAD~1 HEAD 2>/dev/null || echo "")
            INSERTIONS=$(echo "$STAT_LINE" | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
            DELETIONS=$(echo "$STAT_LINE" | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")
            STATS="+${INSERTIONS:-0} ‚àí${DELETIONS:-0}"
          else
            FILE_COUNT=$(git ls-files | wc -l | tr -d ' ')
            FILES=$(git ls-files | head -8 | tr '\n' ',' | sed 's/,$//')
            STATS="initial commit"
          fi

          # === Build description with jq (safe escaping) ===
          if [ -n "$BODY" ]; then
            DESC=$(jq -n --arg t "$TITLE" --arg b "$BODY" '"**" + $t + "**\n\n```\n" + $b + "```"')
          else
            DESC=$(jq -n --arg t "$TITLE" '"**" + $t + "**"')
          fi

          # === Build payload ===
          PAYLOAD=$(jq -n \
            --argjson desc "$DESC" \
            --arg type "$TYPE" \
            --argjson color "$COLOR" \
            --arg file_count "$FILE_COUNT" \
            --arg files "$FILES" \
            --arg sha "$SHA" \
            --arg stats "$STATS" \
            --arg branch "$BRANCH" \
            --arg repo "$REPO" \
            --arg full_sha "$FULL_SHA" \
            --arg before "$BEFORE" \
            --arg author "$AUTHOR" \
            --arg actor "$ACTOR" \
            --arg timestamp "$TIMESTAMP" \
            '{
              embeds: [{
                title: $type,
                description: $desc,
                color: $color,
                fields: [
                  { name: "üìÅ Files Changed", value: ("`" + $file_count + "` files\n```" + $files + "```"), inline: false },
                  { name: "üîó Commit", value: ("[`" + $sha + "`](https://github.com/" + $repo + "/commit/" + $full_sha + ")"), inline: true },
                  { name: "üìä Changes", value: ("`" + $stats + "`"), inline: true },
                  { name: "üåø Branch", value: ("`" + $branch + "`"), inline: true },
                  { name: "üîç Compare", value: ("[View Diff](https://github.com/" + $repo + "/compare/" + $before + "..." + $full_sha + ")"), inline: true }
                ],
                author: { name: $author, icon_url: ("https://github.com/" + $actor + ".png") },
                timestamp: $timestamp,
                footer: { text: ("SyriaBot ‚Ä¢ " + $repo), icon_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" }
              }]
            }')

          # === Send to Discord ===
          HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -X POST -d "$PAYLOAD" "$WEBHOOK_URL")

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error::Discord webhook failed (HTTP $HTTP_CODE)"
            cat /tmp/response.txt
            exit 1
          fi
          echo "‚úì Discord notification sent (HTTP $HTTP_CODE)"

          # === Update category name ===
          HTTP_CODE=$(curl -s -o /tmp/cat.txt -w "%{http_code}" \
            -X PATCH "https://discord.com/api/v10/channels/${MODS_CATEGORY_ID}" \
            -H "Authorization: Bot ${DISCORD_BOT_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"name\": \"SYRIA„Éª${SHA}\"}")

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::warning::Category update failed (HTTP $HTTP_CODE)"
          else
            echo "‚úì Category updated (HTTP $HTTP_CODE)"
          fi
