name: Discord Push Notification

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get commit info
        id: commit
        run: |
          # Get title (first line)
          TITLE=$(git log -1 --pretty=%s)
          echo "title=$TITLE" >> $GITHUB_OUTPUT

          # Determine commit type and color
          if echo "$TITLE" | grep -qiE '^fix|bug|patch'; then
            echo "color=15158332" >> $GITHUB_OUTPUT  # Red for fixes
            echo "type=üêõ Bug Fix" >> $GITHUB_OUTPUT
          elif echo "$TITLE" | grep -qiE '^feat|add|new'; then
            echo "color=3066993" >> $GITHUB_OUTPUT   # Green for features
            echo "type=‚ú® New Feature" >> $GITHUB_OUTPUT
          elif echo "$TITLE" | grep -qiE '^refactor|clean|improve'; then
            echo "color=10181046" >> $GITHUB_OUTPUT  # Purple for refactor
            echo "type=‚ôªÔ∏è Refactor" >> $GITHUB_OUTPUT
          elif echo "$TITLE" | grep -qiE '^doc|readme'; then
            echo "color=3447003" >> $GITHUB_OUTPUT   # Blue for docs
            echo "type=üìö Documentation" >> $GITHUB_OUTPUT
          elif echo "$TITLE" | grep -qiE '^test'; then
            echo "color=16776960" >> $GITHUB_OUTPUT  # Yellow for tests
            echo "type=üß™ Tests" >> $GITHUB_OUTPUT
          else
            echo "color=9807270" >> $GITHUB_OUTPUT   # Gray for other
            echo "type=üìù Update" >> $GITHUB_OUTPUT
          fi

          # Get body - extract bullet points and convert to numbered list
          BODY=$(git log -1 --pretty=%b | grep -E '^- ' | nl -w1 -s'. ' | sed 's/^[[:space:]]*//' | sed 's/^[0-9]*\. - /&/' | sed 's/- //')
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha=$(git log -1 --pretty=%h)" >> $GITHUB_OUTPUT

          # Get file count and list
          FILE_COUNT=$(git diff --name-only HEAD~1 HEAD | wc -l | tr -d ' ')
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

          FILES=$(git diff --name-only HEAD~1 HEAD | head -8 | tr '\n' ',' | sed 's/,$//')
          echo "files=$FILES" >> $GITHUB_OUTPUT

          # Get stats
          STATS=$(git diff --shortstat HEAD~1 HEAD | sed 's/ files\? changed//' | sed 's/ insertions\?(+)/+/' | sed 's/ deletions\?(-)/‚àí/' | tr -d ' ')
          echo "stats=${STATS:-no changes}" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -eo pipefail

          # Read values into variables
          TITLE='${{ steps.commit.outputs.title }}'
          BODY='${{ steps.commit.outputs.body }}'
          FILES='${{ steps.commit.outputs.files }}'
          TYPE='${{ steps.commit.outputs.type }}'
          COLOR='${{ steps.commit.outputs.color }}'
          FILE_COUNT='${{ steps.commit.outputs.file_count }}'
          SHA='${{ steps.commit.outputs.sha }}'
          STATS='${{ steps.commit.outputs.stats }}'
          AUTHOR='${{ steps.commit.outputs.author }}'
          BRANCH='${{ github.ref_name }}'
          REPO='${{ github.repository }}'
          COMMIT_SHA='${{ github.sha }}'
          BEFORE='${{ github.event.before }}'
          ACTOR='${{ github.actor }}'
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Build description with jq
          if [ -n "$BODY" ]; then
            DESC=$(jq -n --arg t "$TITLE" --arg b "$BODY" '"**" + $t + "**\n\n```\n" + $b + "```"') || {
              echo "::error::Failed to build description with jq"
              exit 1
            }
          else
            DESC=$(jq -n --arg t "$TITLE" '"**" + $t + "**"') || {
              echo "::error::Failed to build description with jq"
              exit 1
            }
          fi

          # Build full payload with jq (handles all escaping automatically)
          PAYLOAD=$(jq -n \
            --argjson desc "$DESC" \
            --arg type "$TYPE" \
            --argjson color "$COLOR" \
            --arg file_count "$FILE_COUNT" \
            --arg files "$FILES" \
            --arg sha "$SHA" \
            --arg stats "$STATS" \
            --arg branch "$BRANCH" \
            --arg repo "$REPO" \
            --arg commit_sha "$COMMIT_SHA" \
            --arg before "$BEFORE" \
            --arg author "$AUTHOR" \
            --arg actor "$ACTOR" \
            --arg timestamp "$TIMESTAMP" \
            '{
              embeds: [{
                title: $type,
                description: $desc,
                color: $color,
                fields: [
                  {
                    name: "üìÅ Files Changed",
                    value: ("`" + $file_count + "` files\n```" + $files + "```"),
                    inline: false
                  },
                  {
                    name: "üîó Commit",
                    value: ("[`" + $sha + "`](https://github.com/" + $repo + "/commit/" + $commit_sha + ")"),
                    inline: true
                  },
                  {
                    name: "üìä Changes",
                    value: ("`" + $stats + "`"),
                    inline: true
                  },
                  {
                    name: "üåø Branch",
                    value: ("`" + $branch + "`"),
                    inline: true
                  },
                  {
                    name: "üîç Compare",
                    value: ("[View Diff](https://github.com/" + $repo + "/compare/" + $before + "..." + $commit_sha + ")"),
                    inline: true
                  }
                ],
                author: {
                  name: $author,
                  icon_url: ("https://github.com/" + $actor + ".png")
                },
                timestamp: $timestamp,
                footer: {
                  text: ("SyriaBot ‚Ä¢ " + $repo),
                  icon_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                }
              }]
            }') || {
            echo "::error::Failed to build JSON payload with jq"
            exit 1
          }

          # Send to Discord and check response
          HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -X POST -d "$PAYLOAD" "$WEBHOOK_URL")

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error::Discord webhook failed with HTTP $HTTP_CODE"
            cat /tmp/response.txt
            exit 1
          fi

          echo "Discord notification sent successfully (HTTP $HTTP_CODE)"

      - name: Update category name with commit ID
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          MODS_CATEGORY_ID: ${{ secrets.MODS_CATEGORY_ID }}
        run: |
          HTTP_CODE=$(curl -s -o /tmp/category_response.txt -w "%{http_code}" \
            -X PATCH "https://discord.com/api/v10/channels/${MODS_CATEGORY_ID}" \
            -H "Authorization: Bot ${DISCORD_BOT_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"name\": \"SYRIA„Éª${{ steps.commit.outputs.sha }}\"}")

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::warning::Failed to update category name (HTTP $HTTP_CODE)"
            cat /tmp/category_response.txt
          else
            echo "Category name updated successfully (HTTP $HTTP_CODE)"
          fi
