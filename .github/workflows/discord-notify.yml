name: Discord Push Notification

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get commit info
        id: commit
        run: |
          # Get title (first line)
          TITLE=$(git log -1 --pretty=%s)
          echo "title=$TITLE" >> $GITHUB_OUTPUT

          # Determine commit type and color
          if echo "$TITLE" | grep -qiE '^fix|bug|patch'; then
            echo "color=15158332" >> $GITHUB_OUTPUT  # Red for fixes
            echo "type=üêõ Bug Fix" >> $GITHUB_OUTPUT
          elif echo "$TITLE" | grep -qiE '^feat|add|new'; then
            echo "color=3066993" >> $GITHUB_OUTPUT   # Green for features
            echo "type=‚ú® New Feature" >> $GITHUB_OUTPUT
          elif echo "$TITLE" | grep -qiE '^refactor|clean|improve'; then
            echo "color=10181046" >> $GITHUB_OUTPUT  # Purple for refactor
            echo "type=‚ôªÔ∏è Refactor" >> $GITHUB_OUTPUT
          elif echo "$TITLE" | grep -qiE '^doc|readme'; then
            echo "color=3447003" >> $GITHUB_OUTPUT   # Blue for docs
            echo "type=üìö Documentation" >> $GITHUB_OUTPUT
          elif echo "$TITLE" | grep -qiE '^test'; then
            echo "color=16776960" >> $GITHUB_OUTPUT  # Yellow for tests
            echo "type=üß™ Tests" >> $GITHUB_OUTPUT
          else
            echo "color=9807270" >> $GITHUB_OUTPUT   # Gray for other
            echo "type=üìù Update" >> $GITHUB_OUTPUT
          fi

          # Get body and convert bullet points to numbered list
          echo "body<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=%b | grep -E '^- ' | nl -w1 -s'. ' | sed 's/^//' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha=$(git log -1 --pretty=%h)" >> $GITHUB_OUTPUT

          # Get file count and list
          FILE_COUNT=$(git diff --name-only HEAD~1 HEAD | wc -l | tr -d ' ')
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "files=$(git diff --name-only HEAD~1 HEAD | head -8 | tr '\n' ', ' | sed 's/,$//')" >> $GITHUB_OUTPUT

          # Get stats
          STATS=$(git diff --shortstat HEAD~1 HEAD | sed 's/ files\? changed//' | sed 's/ insertions\?(+)/+/' | sed 's/ deletions\?(-)/‚àí/' | tr -d ' ')
          echo "stats=${STATS:-no changes}" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          COMMIT_TITLE: ${{ steps.commit.outputs.title }}
          COMMIT_BODY: ${{ steps.commit.outputs.body }}
          COMMIT_FILES: ${{ steps.commit.outputs.files }}
        run: |
          # Escape special characters for JSON using env vars (safer for special chars)
          TITLE=$(echo "$COMMIT_TITLE" | sed 's/"/\\"/g' | head -c 200)
          BODY=$(echo "$COMMIT_BODY" | sed 's/- //g' | sed 's/"/\\"/g' | awk '{printf "%s\\n", $0}' | sed 's/\\n$//')
          FILES=$(echo "$COMMIT_FILES" | sed 's/"/\\"/g')

          # Build description
          if [ -n "$BODY" ]; then
            DESC="**$TITLE**\n\n\`\`\`\n$BODY\`\`\`"
          else
            DESC="**$TITLE**"
          fi

          curl -H "Content-Type: application/json" -X POST "$WEBHOOK_URL" -d "{
            \"embeds\": [{
              \"title\": \"${{ steps.commit.outputs.type }}\",
              \"description\": \"$DESC\",
              \"color\": ${{ steps.commit.outputs.color }},
              \"fields\": [
                {
                  \"name\": \"üìÅ Files Changed\",
                  \"value\": \"\`${{ steps.commit.outputs.file_count }}\` files\n\`\`\`$FILES\`\`\`\",
                  \"inline\": false
                },
                {
                  \"name\": \"üîó Commit\",
                  \"value\": \"[\`${{ steps.commit.outputs.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\",
                  \"inline\": true
                },
                {
                  \"name\": \"üìä Changes\",
                  \"value\": \"\`${{ steps.commit.outputs.stats }}\`\",
                  \"inline\": true
                },
                {
                  \"name\": \"üåø Branch\",
                  \"value\": \"\`${{ github.ref_name }}\`\",
                  \"inline\": true
                },
                {
                  \"name\": \"üîç Compare\",
                  \"value\": \"[View Diff](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})\",
                  \"inline\": true
                }
              ],
              \"author\": {
                \"name\": \"${{ steps.commit.outputs.author }}\",
                \"icon_url\": \"https://github.com/${{ github.actor }}.png\"
              },
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
              \"footer\": {
                \"text\": \"SyriaBot ‚Ä¢ ${{ github.repository }}\",
                \"icon_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
              }
            }]
          }"

      - name: Update category name with commit ID
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          MODS_CATEGORY_ID: ${{ secrets.MODS_CATEGORY_ID }}
        run: |
          curl -s -X PATCH "https://discord.com/api/v10/channels/${MODS_CATEGORY_ID}" \
            -H "Authorization: Bot ${DISCORD_BOT_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"name\": \"SYRIA „Éª${{ steps.commit.outputs.sha }}\"}"
